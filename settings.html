<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - The Round Room</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="images/Icon.png">
    <script src="script.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&display=swap" rel="stylesheet">
</head>
<body class="staff-page">
    <div id="adminGate" style="position:fixed; inset:0; background:rgba(0,0,0,0.85); color:#fff; z-index:5000; display:flex; align-items:center; justify-content:center;">
        <div style="max-width:360px; width:90%; background:#111; padding:1.5rem; border-radius:8px; text-align:center;">
            <h3 style="margin-top:0;">Admin Access</h3>
            <p class="muted" style="color:#ccc;">Enter admin token to continue.</p>
            <input type="password" id="adminTokenInput" placeholder="Admin token" style="width:100%; padding:0.6rem; margin:0.75rem 0;">
            <button id="adminTokenBtn" class="btn" style="width:100%;">Unlock</button>
            <p id="adminGateError" style="color:#ffb3b3; margin-top:0.75rem; display:none;">Invalid token.</p>
        </div>
    </div>
    <nav class="top-nav">
        <div class="container">
            <button class="arrow" onclick="window.location.href='pookie.html'">
                <div class = "bar4"></div>
                <div class = "bar5"></div>
            </button>
            <div class="logo">
                <h1>THE ROUND ROOM</h1>
            </div>
            <img class="iconpic" src="images/Icon.png" alt="Logo">
        </div>
    </nav>
    <main class="settings-page">
        <div class="settings-card">
            <div class="settings-header">
                <h2>Settings</h2>
                <p class="muted">Update store settings.</p>
            </div>

            <form class="settings-form">
                <div class="form-group">
                    <label for="taxRate">Tax rate (%)</label>
                    <input id="taxRate" name="taxRate" type="number" min="0" step="0.1" placeholder="e.g., 5">
                </div>

                <div class="form-group">
                    <label for="currency">Currency</label>
                    <input id="currency" name="currency" type="text" placeholder="e.g., INR">
                </div>

                <div class="form-group">
                    <label for="invoicePrefix">Invoice prefix</label>
                    <input id="invoicePrefix" name="invoicePrefix" type="text" placeholder="e.g., ORD">
                </div>

                <div class="form-group">
                    <label for="shopStatus">Shop status</label>
                    <select id="shopStatus" name="shopStatus">
                        <option value="open">Open</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="minOrder">Minimum order value (â‚¹)</label>
                    <input id="minOrder" name="minOrder" type="number" min="0" step="1" placeholder="e.g., 300">
                </div>

                <button type="button" class="btn" id="saveSettingsBtn">Save Settings</button>
            </form>
        </div>
    </main>

    <script>
    async function verifyAdminToken(token) {
        try {
            const response = await fetch('/.netlify/functions/settings', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json', 'x-admin-token': token }
            });
            return response.ok;
        } catch (e) {
            console.error('[settings] Token verification failed:', e);
            return false;
        }
    }

    async function unlockAdmin() {
        const input = document.getElementById('adminTokenInput');
        const error = document.getElementById('adminGateError');
        const token = input.value.trim();
        if (!token) return;
        const ok = await verifyAdminToken(token);
        if (ok) {
            localStorage.setItem('rr_admin_token', token);
            document.getElementById('adminGate').style.display = 'none';
            console.debug('[settings] Admin unlocked');
            return;
        }
        error.style.display = 'block';
    }

    document.getElementById('adminTokenBtn').addEventListener('click', unlockAdmin);
    document.getElementById('adminTokenInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') unlockAdmin();
    });

    (async function gateOnLoad() {
        const token = localStorage.getItem('rr_admin_token');
        if (token && await verifyAdminToken(token)) {
            document.getElementById('adminGate').style.display = 'none';
        }
    })();

    function getAdminToken() {
        console.debug('[settings] Requesting admin token');
        let token = localStorage.getItem('rr_admin_token');
        if (!token) {
            token = prompt('Enter admin token');
            if (token) localStorage.setItem('rr_admin_token', token);
        }
        console.debug('[settings] Admin token present:', Boolean(token));
        return token;
    }

    async function loadSettings() {
        const token = getAdminToken();
        if (!token) return;
        console.debug('[settings] Loading settings');
        try {
            const response = await fetch('/.netlify/functions/settings', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json', 'x-admin-token': token }
            });
            if (!response.ok) throw new Error('Failed to load settings');
            const data = await response.json();

            console.debug('[settings] Loaded settings');

            document.getElementById('taxRate').value = data.taxRate ?? '';
            document.getElementById('currency').value = data.currency || 'INR';
            document.getElementById('invoicePrefix').value = data.invoicePrefix || 'ORD';
            document.getElementById('shopStatus').value = data.storeOpen === false ? 'closed' : 'open';
            document.getElementById('minOrder').value = data.minOrder ?? '';
        } catch (e) {
            console.error('[settings] Load failed:', e);
            alert(`Error loading settings: ${e.message}`);
        }
    }

    async function saveSettings() {
        const token = getAdminToken();
        if (!token) return;
        console.debug('[settings] Saving settings');
        const payload = {
            taxRate: Number(document.getElementById('taxRate').value || 0),
            currency: document.getElementById('currency').value.trim() || 'INR',
            invoicePrefix: document.getElementById('invoicePrefix').value.trim() || 'ORD',
            storeOpen: document.getElementById('shopStatus').value === 'open',
            minOrder: Number(document.getElementById('minOrder').value || 0)
        };

        try {
            const response = await fetch('/.netlify/functions/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'x-admin-token': token },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('Failed to save settings');
            console.debug('[settings] Save success');
            alert('Settings saved');
        } catch (e) {
            console.error('[settings] Save failed:', e);
            alert(`Error saving settings: ${e.message}`);
        }
    }

    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
    document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>