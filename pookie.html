<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Round Room</title>   
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="images/Icon.png">
    <script src="script.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&display=swap" rel="stylesheet">
</head>
<body class="staff-page">
    <div id="adminGate" style="position:fixed; inset:0; background:rgba(0,0,0,0.85); color:#fff; z-index:5000; display:flex; align-items:center; justify-content:center;">
        <div style="max-width:360px; width:90%; background:#111; padding:1.5rem; border-radius:8px; text-align:center;">
            <h3 style="margin-top:0;">Admin Access</h3>
            <p class="muted" style="color:#ccc;">Enter admin token to continue.</p>
            <input type="password" id="adminTokenInput" placeholder="Admin token" style="width:100%; padding:0.6rem; margin:0.75rem 0;">
            <button id="adminTokenBtn" class="btn" style="width:100%;">Unlock</button>
            <p id="adminGateError" style="color:#ffb3b3; margin-top:0.75rem; display:none;">Invalid token.</p>
        </div>
    </div>
    <nav class="top-nav">
        <div class="container">
            <div class="nav-toggle" onclick="changeHamburger(this)">
                <div class = "bar1"></div>
                <div class = "bar2"></div>
                <div class = "bar3"></div>
            </div>
            <ul class="nav-links" id="TopNav">
                <li><a href="/menu-admin">Manage Menu</a></li>
                <li><a href="/pincodes-admin">Pincodes</a></li>
                <li><a href="/settings">Settings</a></li>
                <li><a href="/admin">Admin Tools</a></li>
            </ul>
            <div class="logo">
                <h1 href="#story">THE ROUND ROOM</h1>
            </div>
            <img class="iconpic" src="images/Icon.png" alt="Logo">
        </div>
    </nav>

    <main style="padding:var(--spacing-lg) var(--spacing-md);">
        <section class="valentine-card" aria-labelledby="valentineTitle">
            <div class="valentine-content">
                <h2 id="valentineTitle">Will you be my Valentine, Jia?</h2>
                <p class="muted" id="valentineMessage">Choose wisely ðŸ’–</p>
                <div class="valentine-actions">
                    <button class="btn" id="valentineYes" type="button">Yes</button>
                    <button class="btn btn-delete" id="valentineNo" type="button">No</button>
                </div>
            </div>
            <canvas id="valentineCanvas" aria-hidden="true"></canvas>
        </section>

        <div style="display: flex; justify-content: space-between; align-items: center; margin: 4.5rem;">
            <div>
                <h2>Staff Orders</h2>
                <p class="muted">Orders placed. Use this view to mark orders as Preparing/Ready/Completed.</p>
            </div>
        </div>

        <div id="ordersTableWrapper" style="margin-top:1rem;">
            <table class="orders-table" id="ordersTable" aria-live="polite">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Placed</th>
                        <th>Status</th>
                        <th>View</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="ordersTbody">
                    <tr><td colspan="6" class="muted">Loading ordersâ€¦</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Order details modal -->
        <div id="orderModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
            <div class="modal-content" role="document">
                <button class="modal-close" id="modalClose" aria-label="Close">âœ•</button>
                <div id="modalBody"></div>
            </div>
        </div>

    </main>

    <footer class="site-footer">
        <div class="footer-inner">
            <div class="footer-links">
                <a href="/privacy">Privacy</a>
                <span aria-hidden="true">â€¢</span>
                <a href="/terms">Terms</a>
                <span aria-hidden="true">â€¢</span>
                <a href="/refund">Refund</a>
                <span aria-hidden="true">â€¢</span>
                <a href="/contact">Contact</a>
            </div>
            <div class="footer-meta">Established 2025 | @theroundroommumbai | Velvet Lounge Enterprises Pvt.Ltd</div>
        </div>
    </footer>

    <script src="js/admin-gate.js"></script>
    <script>
    function fmtDate(iso) {
        try { return new Date(iso).toLocaleString(); } catch (e) { return iso; }
    }

    function initValentine() {
        const yesBtn = document.getElementById('valentineYes');
        const noBtn = document.getElementById('valentineNo');
        const message = document.getElementById('valentineMessage');
        const canvas = document.getElementById('valentineCanvas');
        if (!yesBtn || !noBtn || !message || !canvas) return;

        let animating = false;
        let particles = [];
        let animationId = null;

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = Math.max(1, rect.width);
            canvas.height = Math.max(1, rect.height);
        }

        function createExplosion(x, y) {
            const count = 60;
            for (let i = 0; i < count; i += 1) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 1 + Math.random() * 3.5;
                particles.push({
                    x,
                    y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 60 + Math.random() * 40,
                    color: `hsl(${Math.random() * 360}, 80%, 60%)`
                });
            }
        }

        function step() {
            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles = particles.filter(p => p.life > 0);
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.02;
                p.life -= 1;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2.2, 0, Math.PI * 2);
                ctx.fill();
            });

            if (animating || particles.length > 0) {
                animationId = requestAnimationFrame(step);
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function startFireworks() {
            if (animating) return;
            animating = true;
            resizeCanvas();
            createExplosion(canvas.width * 0.3, canvas.height * 0.5);
            createExplosion(canvas.width * 0.7, canvas.height * 0.4);
            createExplosion(canvas.width * 0.5, canvas.height * 0.6);
            step();

            setTimeout(() => {
                animating = false;
            }, 2500);
        }

        function stopFireworks() {
            animating = false;
            particles = [];
            if (animationId) cancelAnimationFrame(animationId);
            const ctx = canvas.getContext('2d');
            if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        yesBtn.addEventListener('click', () => {
            message.textContent = 'Yay! You made my day ðŸ’˜';
            startFireworks();
        });

        noBtn.addEventListener('click', () => {
            message.textContent = 'Is it too late now to say sorry?';
            stopFireworks();
        });

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
    }

    function renderOrders(orders) {
        const hidden = getHiddenOrders();
        const visibleOrders = (orders || []).filter(o => !hidden.has(o.orderNumber));
        const tbody = document.getElementById('ordersTbody');
        if (!visibleOrders || visibleOrders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="muted">No orders yet.</td></tr>';
            return;
        }

        tbody.innerHTML = visibleOrders.map(o => {
            const customer = o.customer?.name || 'â€”';
            const placed = o.createdAt ? fmtDate(o.createdAt) : 'â€”';
            const status = o.status || 'CREATED';
            return `
                <tr>
                    <td>${o.orderNumber || 'â€”'}</td>
                    <td>${customer}</td>
                    <td>${placed}</td>
                    <td>
                        <select data-order="${o.orderNumber}" class="order-status-select">
                            ${['CREATED','PAYMENT_PENDING','PAID','PREPARING','COMPLETED','CANCELLED'].map(s =>
                                `<option value="${s}" ${s === status ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td><button class="btn" data-view="${o.orderNumber}">View</button></td>
                    <td><button class="btn btn-delete" data-delete="${o.orderNumber}">Delete</button></td>
                </tr>
            `;
        }).join('');
    }

    function showOrderModal(order) {
        const modal = document.getElementById('orderModal');
        const body = document.getElementById('modalBody');
        if (!modal || !body) return;

        const itemsHtml = (order.items || []).map(i => `
            <div class="checkout-item">
                <div class="left"><span class="qty">${i.qty}x</span><span class="name">${i.name}</span></div>
                <div>â‚¹${Number(i.lineTotal || 0).toFixed(2)}</div>
            </div>
        `).join('');

        body.innerHTML = `
            <h3>Order ${order.orderNumber}</h3>
            <p><strong>Status:</strong> ${order.status}</p>
            <p><strong>Customer:</strong> ${order.customer?.name || 'â€”'}</p>
            <p><strong>Phone:</strong> ${order.customer?.phone || 'â€”'}</p>
            <p><strong>Email:</strong> ${order.customer?.email || 'â€”'}</p>
            <p><strong>Address:</strong> ${order.customer?.address || 'â€”'}</p>
            <p><strong>Note:</strong> ${order.customer?.note || 'â€”'}</p>
            <div class="checkout-items" style="margin-top:1rem;">${itemsHtml || '<p>No items.</p>'}</div>
            <div class="checkout-breakdown" style="margin-top:1rem;">
                <div class="row"><span>Subtotal</span><span>â‚¹${Number(order.pricing?.subtotal || 0).toFixed(2)}</span></div>
                <div class="row"><span>Tax</span><span>â‚¹${Number(order.pricing?.tax || 0).toFixed(2)}</span></div>
                <div class="row total"><span>Total</span><span>â‚¹${Number(order.pricing?.total || 0).toFixed(2)}</span></div>
            </div>
        `;

        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
    }

    async function loadOrders() {
        const tbody = document.getElementById('ordersTbody');
        tbody.innerHTML = '<tr><td colspan="6" class="muted">Loading ordersâ€¦</td></tr>';
        const orders = await getOrders();
        renderOrders(orders);
    }

    function bindOrdersTable() {
        const table = document.getElementById('ordersTable');
        if (!table) return;

        table.addEventListener('change', async (e) => {
            const select = e.target.closest('.order-status-select');
            if (!select) return;
            const orderNumber = select.getAttribute('data-order');
            await updateOrderStatus(orderNumber, select.value);
        });

        table.addEventListener('click', async (e) => {
            const viewBtn = e.target.closest('[data-view]');
            const delBtn = e.target.closest('[data-delete]');
            if (viewBtn) {
                const orderNumber = viewBtn.getAttribute('data-view');
                const orders = await getOrders();
                const order = orders.find(o => o.orderNumber === orderNumber);
                if (order) showOrderModal(order);
            }
            if (delBtn) {
                const orderNumber = delBtn.getAttribute('data-delete');
                if (confirm(`Remove order ${orderNumber} from this view?`)) {
                    hideOrderLocally(orderNumber);
                    await loadOrders();
                }
            }
        });
    }

    function getHiddenOrders() {
        try {
            const raw = localStorage.getItem('rr_hidden_orders') || '[]';
            const parsed = JSON.parse(raw);
            return new Set(Array.isArray(parsed) ? parsed : []);
        } catch (e) {
            return new Set();
        }
    }

    function hideOrderLocally(orderNumber) {
        if (!orderNumber) return;
        const hidden = getHiddenOrders();
        hidden.add(orderNumber);
        try {
            localStorage.setItem('rr_hidden_orders', JSON.stringify(Array.from(hidden)));
        } catch (e) { /* ignore */ }
    }

    document.getElementById('modalClose').addEventListener('click', () => {
        const modal = document.getElementById('orderModal');
        if (modal) {
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        if (window.AdminGate) {
            window.AdminGate.requireAdminAccess(() => {
                initValentine();
                bindOrdersTable();
                loadOrders();
                window.addEventListener('ordersUpdated', loadOrders);
            });
        }
    });
    </script>

</body>
</html>


