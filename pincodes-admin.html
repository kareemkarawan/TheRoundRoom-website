<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Pincodes Admin - The Round Room</title>   
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="images/Icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&display=swap" rel="stylesheet">
    <style>
        .admin-container { max-width: 900px; margin: 0 auto; margin-top: 6rem; padding: var(--spacing-lg) var(--spacing-md); }
        
        /* Bulk input section */
        .bulk-input-section { border: 1px solid #ddd; padding: 1.5rem; border-radius: 6px; margin-bottom: 2rem; background: #f9f9f9; }
        .bulk-input-section h3 { margin-top: 0; font-size: 1rem; }
        .bulk-input-section textarea { width: 100%; height: 120px; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 0.9rem; resize: vertical; }
        .bulk-input-help { font-size: 0.85rem; color: #666; margin: 0.75rem 0 0; }
        .btn-bulk-add { background: #2196F3; color: #fff; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; margin-top: 1rem; cursor: pointer; }
        .btn-bulk-add:hover { background: #0b7dda; }
        
        /* Table styles */
        .pincodes-table-wrapper { overflow-x: auto; }
        .pincodes-table { width: 100%; border-collapse: collapse; border: 1px solid #ddd; }
        .pincodes-table thead { background: #f5f5f5; }
        .pincodes-table th, .pincodes-table td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        .pincodes-table th { font-weight: 600; border-bottom: 1px solid #ddd; }
        .pincodes-table tbody tr:hover { background: #fafafa; }
        .pincodes-table .pincode-code { font-weight: 600; font-family: monospace; }
        .pincodes-table .action-cell { width: 100px; text-align: center; }
        .btn-delete-small { background: #f44336; color: #fff; border: none; padding: 0.4rem 0.8rem; border-radius: 3px; cursor: pointer; font-size: 0.85rem; }
        .btn-delete-small:hover { background: #da190b; }
        
        .message { padding: 1rem; border-radius: 4px; margin-bottom: 1rem; display: none; }
        .message.success { background: #d4edda; color: #155724; display: block; }
        .message.error { background: #f8d7da; color: #721c24; display: block; }
        
        .loading { text-align: center; color: #666; padding: 2rem; }
        .empty-state { text-align: center; color: #999; padding: 2rem; }
    </style>
</head>
<body class="staff-page">
    <nav class="top-nav">
        <div class="container">
            <button class="arrow" onclick="window.location.href='/pookie'">
                    <div class = "bar4"></div>
                    <div class = "bar5"></div>
                </button>
            <div class="logo">
                <h1>THE ROUND ROOM</h1>
            </div>
            <img class="iconpic" src="images/Icon.png" alt="Logo">
        </div>
    </nav>

    <main class="admin-container">
        <h2>Delivery Pincodes</h2>
        <p class="muted">Manage the pincodes where you deliver.</p>

        <div id="messageBox" class="message"></div>

        <!-- Bulk input section -->
        <div class="bulk-input-section">
            <h3>üìù Quick Add (Bulk)</h3>
            <textarea id="bulkPincodeInput" placeholder="Paste or type pincodes separated by newlines or commas. One per line or comma-separated.&#10;Example:&#10;110001&#10;110002&#10;110003"></textarea>
            <div class="bulk-input-help">üí° Tip: Paste Excel column or comma-separated list. Duplicates are skipped.</div>
            <button class="btn-bulk-add" id="bulkAddBtn">Add Pincodes</button>
        </div>

        <!-- Pincodes table -->
        <div class="pincodes-table-wrapper">
            <table class="pincodes-table">
                <thead>
                    <tr>
                        <th>Pincode</th>
                        <th class="action-cell">Action</th>
                    </tr>
                </thead>
                <tbody id="pincodesTableBody">
                    <tr><td colspan="2" class="loading">Loading pincodes‚Ä¶</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <script src="js/admin-gate.js"></script>
    <script>
    let allPincodes = [];

    function getAdminToken() {
        console.debug('[pincodes-admin] Requesting admin token');
        const token = window.AdminGate ? window.AdminGate.getToken() : '';
        console.debug('[pincodes-admin] Admin token present:', Boolean(token));
        return token;
    }

    async function loadPincodes() {
        const tbody = document.getElementById('pincodesTableBody');
        console.debug('[pincodes-admin] Loading pincodes');
        try {
            const response = await fetch('/.netlify/functions/pincodes');
            if (response.ok) {
                allPincodes = await response.json();
                console.debug('[pincodes-admin] Loaded pincodes:', allPincodes.length);
                renderPincodes();
            } else {
                throw new Error('Failed to fetch pincodes');
            }
        } catch (e) {
            console.error('[pincodes-admin] Load failed:', e);
            tbody.innerHTML = `<tr><td colspan="2" class="empty-state">Error loading pincodes: ${e.message}</td></tr>`;
        }
    }

    function renderPincodes() {
        const tbody = document.getElementById('pincodesTableBody');
        if (!allPincodes || allPincodes.length === 0) {
            console.debug('[pincodes-admin] No pincodes to render');
            tbody.innerHTML = '<tr><td colspan="2" class="empty-state">No pincodes yet. Add some to get started!</td></tr>';
            return;
        }

        console.debug('[pincodes-admin] Rendering pincodes:', allPincodes.length);
        
        // Sort pincodes numerically for better display
        const sorted = [...allPincodes].sort((a, b) => {
            const codeA = parseInt(a.code) || 0;
            const codeB = parseInt(b.code) || 0;
            return codeA - codeB;
        });
        
        tbody.innerHTML = sorted.map(p => `
            <tr>
                <td class="pincode-code">${p.code}</td>
                <td class="action-cell">
                    <button class="btn-delete-small" onclick="deletePincode('${p.code}')">Delete</button>
                </td>
            </tr>
        `).join('');
    }

    function showMessage(text, type) {
        console.debug('[pincodes-admin] Message:', type, text);
        const box = document.getElementById('messageBox');
        box.textContent = text;
        box.className = `message ${type}`;
        setTimeout(() => box.className = 'message', 4000);
    }

    async function deletePincode(code) {
        console.debug('[pincodes-admin] Delete pincode:', code);
        if (!confirm(`Delete pincode ${code}?`)) return;
        try {
            const token = getAdminToken();
            if (!token) {
                showMessage('Admin token required. Please try again.', 'error');
                if (window.AdminGate) window.AdminGate.lock();
                return;
            }
            const response = await fetch(`/.netlify/functions/pincodes?id=${code}`, {
                method: 'DELETE',
                headers: { 'x-admin-token': token }
            });
            if (response.ok) {
                console.debug('[pincodes-admin] Delete success:', code);
                showMessage(`Pincode ${code} deleted`, 'success');
                await loadPincodes();
            } else {
                if (response.status === 401) {
                    if (window.AdminGate) window.AdminGate.lock();
                    showMessage('Unauthorized. Please re-enter admin token.', 'error');
                    return;
                }
                throw new Error('Failed to delete');
            }
        } catch (e) {
            console.error('[pincodes-admin] Delete failed:', e);
            showMessage(`Error: ${e.message}`, 'error');
        }
    }

    async function addPincodesBulk(text) {
        console.debug('[pincodes-admin] Bulk add start');
        // Parse input: split by newlines and commas, clean up
        const pincodes = text
            .split(/[\n,]+/)
            .map(p => p.trim())
            .filter(p => p && /^\d+$/.test(p)) // Only valid numeric codes
            .filter((p, i, arr) => arr.indexOf(p) === i); // Remove duplicates

        if (pincodes.length === 0) {
            console.warn('[pincodes-admin] No valid pincodes in bulk input');
            showMessage('No valid pincodes found. Use only digits.', 'error');
            return;
        }

        let added = 0;
        let skipped = 0;

        for (const code of pincodes) {
            // Check if already exists
            if (allPincodes.some(p => p.code === code)) {
                skipped++;
                continue;
            }

            try {
                const token = getAdminToken();
                if (!token) {
                    showMessage('Admin token required. Please try again.', 'error');
                    if (window.AdminGate) window.AdminGate.lock();
                    return;
                }
                const response = await fetch('/.netlify/functions/pincodes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-token': token },
                    body: JSON.stringify({ code, area: '' })
                });
                if (response.ok) {
                    console.debug('[pincodes-admin] Added pincode:', code);
                    added++;
                }
            } catch (e) {
                console.error('[pincodes-admin] Add failed:', code, e);
                console.error(`Failed to add ${code}:`, e);
            }
        }

        document.getElementById('bulkPincodeInput').value = '';
        showMessage(`‚úì Added ${added} pincodes (${skipped} duplicates skipped)`, 'success');
        await loadPincodes();
    }

    // Event listeners
    document.getElementById('bulkAddBtn').addEventListener('click', () => {
        const text = document.getElementById('bulkPincodeInput').value;
        if (text.trim()) {
            console.debug('[pincodes-admin] Bulk add triggered');
            addPincodesBulk(text);
        } else {
            console.warn('[pincodes-admin] Bulk add empty input');
            showMessage('Enter at least one pincode', 'error');
        }
    });

    document.getElementById('bulkPincodeInput').addEventListener('keypress', (e) => {
        if (e.ctrlKey && e.key === 'Enter') {
            console.debug('[pincodes-admin] Bulk add Ctrl+Enter');
            document.getElementById('bulkAddBtn').click();
        }
    });

    // Load pincodes only after admin gate unlocks
    document.addEventListener('DOMContentLoaded', () => {
        if (window.AdminGate) {
            window.AdminGate.requireAdminAccess(loadPincodes);
        }
    });
    </script>
    <footer class="site-footer">
        <div class="footer-inner">
            <div class="footer-links">
                <a href="/privacy">Privacy</a>
                <span aria-hidden="true">‚Ä¢</span>
                <a href="/terms">Terms</a>
                <span aria-hidden="true">‚Ä¢</span>
                <a href="/refund">Refund</a>
                <span aria-hidden="true">‚Ä¢</span>
                <a href="/contact">Contact</a>
            </div>
            <div class="footer-meta">Established 2025 | @theroundroommumbai | Velvet Lounge Enterprises Pvt.Ltd</div>
        </div>
    </footer>
</body>
</html>
